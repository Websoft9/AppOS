# Story 12.3: Audit Log Viewer (Dashboard)

**Epic**: Epic 12 - Operation Audit Log
**Priority**: P2
**Status**: Done
**Depends on**: Story 12.1, Story 12.2

## User Story

As a user, I want to view operation audit history, so that I can verify operation results and investigate failures.

## Acceptance Criteria

- [x] AC1: `/audit` route is accessible to all authenticated users; lists logs ordered by `-created`
- [x] AC2: Member sees only own logs; superuser sees all logs (enforced by PB access rules, no extra code)
- [x] AC3: Filters support `action` (select) and `status` (select)
- [x] AC4: Any row with `detail` can expand inline; shows User-Agent separately, remaining JSON below
- [x] AC5: Pagination with configurable page size (10 / 20 / 50 / 100)
- [x] AC6: IP column (superuser only); sortable column headers (Time, Action, Status, IP, User)

## Tasks / Subtasks

- [x] Task 1: Create `dashboard/src/routes/_app/_auth/audit.tsx`
  - [x] 1.1 Query `pb.collection('audit_logs').getList(page, 20, { sort: '-created', filter })` 
  - [x] 1.2 Table columns: created, action, resource\_name, status badge, user\_email (superuser only)
  - [x] 1.3 Follow table/pagination pattern from `dashboard/src/routes/_app/_auth/files.tsx`
- [x] Task 2: Add filter bar
  - [x] 2.1 `action` select (includes `login.success`, `login.failed`)
  - [x] 2.2 `status` select (`pending | success | failed`)
  - [x] 2.3 Page size selector: 10 / 20 / 50 / 100
- [x] Task 3: Expandable detail panel
  - [x] 3.1 Any row with `detail` is expandable
  - [x] 3.2 User-Agent shown as labelled line; remaining JSON in `<pre>` below
- [x] Task 4: Add Audit nav item to Sidebar (all authenticated users)
- [x] Task 5: Sortable column headers with chevron icons (`SortHeader` component)
- [x] Task 6: IP column for superusers (monospace, `—` when empty)

## Dev Notes

- Route under `_auth` (not `_superuser`) — all authenticated users can access
- Superuser user\_email column: show when `pb.authStore.record?.collectionName === '_superusers'`
- No custom backend endpoint needed; PB SDK list API + access rules handle visibility
- Follow `files.tsx` for table layout, pagination, and empty state patterns

## Dev Agent Record

### Implementation Plan
Created `audit.tsx` under `_app/_auth/` (accessible to all authenticated users). Used native HTML `<select>` elements (shadcn Select component not present in project). State: page, filterAction, filterStatus, expandedId. `fetchLogs` uses `pb.collection('audit_logs').getList()` with sort `-created` and a dynamically built filter string. Table shows: expand icon, time, action (monospace), resource name, status badge, and user email (superuser only). Expandable rows render `detail` JSON via `<pre>`. Pagination uses Previous/Next buttons. Sidebar updated to add "Audit Log" with `ScrollText` icon in the workspace group.

### Completion Notes
All tasks complete. Dashboard builds cleanly. `routeTree.gen.ts` auto-regenerated by vite plugin during build.

## File List

- `dashboard/src/routes/_app/_auth/audit.tsx` — new
- `dashboard/src/components/layout/Sidebar.tsx` — modified: add Audit nav item
- `dashboard/src/routeTree.gen.ts` — auto-updated by vite plugin

## Change Log

| Date | Change |
|------|--------|
| 2026-02-23 | Story created |
| 2026-02-23 | Implemented — audit page, filter bar, expandable detail, sidebar nav |
| 2026-02-23 | Added IP column, sortable headers, page size selector, UA in detail, login actions |
