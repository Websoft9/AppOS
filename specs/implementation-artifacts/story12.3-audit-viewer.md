# Story 12.3: Audit Log Viewer (Dashboard)

**Epic**: Epic 12 - Operation Audit Log
**Priority**: P2
**Status**: Done
**Depends on**: Story 12.1, Story 12.2

## User Story

As a user, I want to view operation audit history, so that I can verify operation results and investigate failures.
As a superuser, I want to view PocketBase system request logs, so that I can investigate API-level activity and errors.

## Acceptance Criteria

- [x] AC1: `/audit` route is accessible to all authenticated users; lists logs ordered by `-created`
- [x] AC2: Member sees only own logs; superuser sees all logs (enforced by PB access rules, no extra code)
- [x] AC3: Filters support `action` (select, includes `service.restart`) and `status` (select)
- [x] AC4: Any row with `detail` can expand inline; shows User-Agent separately, remaining JSON below
- [x] AC5: Pagination with configurable page size (10 / 20 / 50 / 100)
- [x] AC6: IP column (superuser only); sortable column headers (Time, Action, Status, IP, User)
- [x] AC7: Audit page title is "Audit & Logs"; superuser sees a "Logs" ghost button (with `FileText` icon) next to Refresh in the header
- [x] AC8: `/logs` route (superuser-only) queries `GET /api/logs` and renders level, message/URL, status code, exec time; supports level filter, keyword search, pagination
- [x] AC9: Superuser sidebar shows "Logs" nav item; "Audit & Logs" sidebar label

## Tasks / Subtasks

- [x] Task 1: Create `dashboard/src/routes/_app/_auth/audit.tsx`
  - [x] 1.1 Query `pb.collection('audit_logs').getList(page, 20, { sort: '-created', filter })`
  - [x] 1.2 Table columns: created, action, resource\_name, status badge, user\_email (superuser only)
  - [x] 1.3 Follow table/pagination pattern from `dashboard/src/routes/_app/_auth/files.tsx`
- [x] Task 2: Add filter bar
  - [x] 2.1 `action` select (includes `service.restart`, `login.success`, `login.failed`)
  - [x] 2.2 `status` select (`pending | success | failed`)
  - [x] 2.3 Page size selector: 10 / 20 / 50 / 100
- [x] Task 3: Expandable detail panel
  - [x] 3.1 Any row with `detail` is expandable
  - [x] 3.2 User-Agent shown as labelled line; remaining JSON in `<pre>` below
- [x] Task 4: Add "Audit & Logs" nav item to Sidebar (all authenticated users); add "Logs" nav item for superusers
- [x] Task 5: Sortable column headers with chevron icons (`SortHeader` component)
- [x] Task 6: IP column for superusers (monospace, `—` when empty)
- [x] Task 7: Rename audit page title to "Audit & Logs"; add "Logs" ghost button (FileText icon) in header right, next to Refresh — visible to superusers only
- [x] Task 8: Create `dashboard/src/routes/_app/_auth/_superuser/logs.tsx`
  - [x] 8.1 Route under `_superuser` guard — superuser token required, non-superusers redirected
  - [x] 8.2 Fetch `GET /api/logs` via `pb.send()` with `sort=-created`, `page`, `perPage`, `filter`
  - [x] 8.3 Level filter: DEBUG / INFO / WARN / ERROR (maps to slog integer levels -4/0/4/8)
  - [x] 8.4 Keyword search: filters on `message`, `data.url`, `data.error`; applied on Enter or Search button
  - [x] 8.5 Table columns: Time, Level badge, Message/URL (primary text), Status code, Exec(ms)
  - [x] 8.6 Request rows show `METHOD URL` as primary text; level badge color-coded (blue=INFO, yellow=WARN, red=ERROR)
  - [x] 8.7 Expandable detail: full `data` JSON in `<pre>`; message shown separately for request-type logs
  - [x] 8.8 Pagination (20/50/100 per page); back arrow (←) link to `/audit`

## Dev Notes

- `/audit` route under `_auth` — all authenticated users can access
- `/logs` route under `_superuser` — access guard enforced by `_superuser.tsx` beforeLoad
- Superuser `user_email` column and Logs button: check `pb.authStore.record?.collectionName === '_superusers'` (or reuse `isSuperuser` local var)
- No custom backend endpoint; `GET /api/logs` is a built-in PB superuser-only endpoint
- PB log levels follow Go `log/slog` convention: DEBUG=-4, INFO=0, WARN=4, ERROR=8
- `routeTree.gen.ts` is auto-regenerated by vite-plugin-tanstack-router on build; run `npx vite build` once before `tsc -b` if new routes are added

## Dev Agent Record

### Implementation Plan
Created `audit.tsx` under `_app/_auth/` (accessible to all authenticated users). Used native HTML `<select>` elements (shadcn Select component not present in project). State: page, filterAction, filterStatus, expandedId. `fetchLogs` uses `pb.collection('audit_logs').getList()` with sort `-created` and a dynamically built filter string. Table shows: expand icon, time, action (monospace), resource name, status badge, and user email (superuser only). Expandable rows render `detail` JSON via `<pre>`. Pagination uses Previous/Next buttons. Sidebar updated to add "Audit & Logs" with `ScrollText` icon in the admin group.

**Logs page**: Created `_superuser/logs.tsx` using `pb.send('/api/logs', ...)` — PB SDK does not expose a typed logs client, so raw `pb.send()` is used with manual query string construction. Level badge uses slog integer mapping. Primary text for request logs is `METHOD URL`; non-request logs show `message`. Keyword search targets `message`, `data.url`, `data.error` via PB filter syntax. Back arrow links to `/audit`. `routeTree.gen.ts` was regenerated by running `npx vite build` before the final `make build`.

**Header redesign**: "Logs" moved from inline link beside title to a `ghost` `Button` with `FileText` icon in the right-side action area, alongside Refresh. Title simplified to plain `<h2>`. Decision: right side = actions, left side = content label — standard pattern used throughout the app.

### Completion Notes
All tasks complete. `make build` passes cleanly (backend + dashboard). Tested: audit page title, Logs button visibility (superuser only), Logs page level/search/pagination, expand detail, back navigation.

## File List

- `dashboard/src/routes/_app/_auth/audit.tsx` — modified: title → "Audit & Logs"; Logs ghost button; `service.restart` in action filter; `FileText` icon import; `Link` import
- `dashboard/src/routes/_app/_auth/_superuser/logs.tsx` — new: PB system logs viewer
- `dashboard/src/components/layout/Sidebar.tsx` — modified: "Audit & Logs" label; Logs nav item for superusers; `FileText` icon import
- `dashboard/src/routeTree.gen.ts` — auto-updated by vite plugin

## Change Log

| Date | Change |
|------|--------|
| 2026-02-23 | Story created |
| 2026-02-23 | Implemented — audit page, filter bar, expandable detail, sidebar nav |
| 2026-02-23 | Added IP column, sortable headers, page size selector, UA in detail, login actions |
| 2026-02-23 | Added `service.restart` to action filter; title → "Audit & Logs"; Logs ghost button in header; new Logs page (`_superuser/logs.tsx`); Sidebar Logs nav item for superusers |
